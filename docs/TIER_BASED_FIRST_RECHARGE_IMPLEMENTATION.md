# æ¡£ä½ç‹¬ç«‹é¦–å……ä¼˜æƒ  - å®æ–½æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†**æ¯ä¸ªå……å€¼æ¡£ä½ç‹¬ç«‹çš„é¦–å……ä¼˜æƒ **ç³»ç»Ÿï¼Œç”¨æˆ·å¯ä»¥åœ¨æ¯ä¸ªé¢„è®¾æ¡£ä½äº«å—ä¸€æ¬¡é¦–å……ä¼˜æƒ ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **æ¡£ä½ç‹¬ç«‹èµ„æ ¼**ï¼šç”¨æˆ·åœ¨æ¯ä¸ªæ¡£ä½ï¼ˆ10/50/100/200/500/1000å…ƒï¼‰éƒ½æœ‰ç‹¬ç«‹çš„é¦–å……èµ„æ ¼
- âœ… **ç²¾ç¡®åŒ¹é…**ï¼šåªæœ‰å……å€¼é¢„è®¾æ¡£ä½é‡‘é¢æ‰äº«å—é¦–å……ä¼˜æƒ 
- âœ… **è‡ªå®šä¹‰é‡‘é¢ä¿ç•™**ï¼šç”¨æˆ·å¯ä»¥å……å€¼è‡ªå®šä¹‰é‡‘é¢ï¼Œä½†ä¸äº«å—é¦–å……ä¼˜æƒ 
- âœ… **å‘åå…¼å®¹**ï¼šç°æœ‰æ•°æ®è‡ªåŠ¨è¿ç§»ï¼Œä¸å½±å“å·²å‚ä¸ç”¨æˆ·

---

## ğŸ¯ ç”¨æˆ·ä½“éªŒç¤ºä¾‹

```
ç”¨æˆ·Aç¬¬ä¸€æ¬¡è®¿é—®å……å€¼é¡µé¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ğŸ+Â¥2   â”‚ â”‚ğŸ+Â¥10  â”‚ â”‚ğŸ+Â¥20  â”‚
â”‚  Â¥10   â”‚ â”‚  Â¥50   â”‚ â”‚ Â¥100   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å…¨éƒ¨å¯äº«å—é¦–å……ä¼˜æƒ 

ç”¨æˆ·Aå……å€¼100å…ƒåï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ğŸ+Â¥2   â”‚ â”‚ğŸ+Â¥10  â”‚ â”‚ Â¥100   â”‚ â† å·²å……å€¼ï¼Œæ— æ ‡ç­¾
â”‚  Â¥10   â”‚ â”‚  Â¥50   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·Aå……å€¼50å…ƒåï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ğŸ+Â¥2   â”‚ â”‚ Â¥50    â”‚ â”‚ Â¥100   â”‚
â”‚  Â¥10   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†‘         â†‘           â†‘
è¿˜å¯å……å€¼  å·²å……å€¼è¿‡   å·²å……å€¼è¿‡
```

---

## ğŸ“Š æ•°æ®åº“å˜æ›´

### è¡¨ç»“æ„ä¿®æ”¹

**`first_recharge_bonus_log` è¡¨**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å˜æ›´ |
|------|------|------|------|
| `id` | String | è®°å½•ID | æ—  |
| `user_id` | String | ç”¨æˆ·ID | âŒ ç§»é™¤å”¯ä¸€ç´¢å¼• |
| `tier_amount` | Integer | **æ¡£ä½é‡‘é¢ï¼ˆæ¯«ï¼‰** | **âœ… æ–°å¢** |
| `recharge_amount` | Integer | å®é™…å……å€¼é‡‘é¢ï¼ˆæ¯«ï¼‰ | æ—  |
| `bonus_amount` | Integer | å¥–åŠ±é‡‘é¢ï¼ˆæ¯«ï¼‰ | æ—  |
| `bonus_rate` | Integer | è¿”ç°æ¯”ä¾‹ï¼ˆ%ï¼‰ | æ—  |
| `created_at` | BigInteger | å‚ä¸æ—¶é—´ | æ—  |

**æ–°å¢å¤åˆå”¯ä¸€ç´¢å¼•**ï¼š`(user_id, tier_amount)` - æ¯ä¸ªç”¨æˆ·æ¯ä¸ªæ¡£ä½åªèƒ½å……å€¼ä¸€æ¬¡

---

## ğŸ”§ å®æ–½çš„ä¿®æ”¹

### 1. æ•°æ®åº“å±‚ (`backend/open_webui/models/billing.py`)

**æ–°å¢æ–¹æ³•**ï¼š
- `has_participated_tier(user_id, tier_amount)` - æ£€æŸ¥æŒ‡å®šæ¡£ä½èµ„æ ¼
- `get_participated_tiers(user_id)` - è·å–ç”¨æˆ·å·²å……å€¼çš„æ¡£ä½åˆ—è¡¨
- `create(..., tier_amount, ...)` - åˆ›å»ºè®°å½•æ—¶æŒ‡å®šæ¡£ä½

### 2. API å±‚ (`backend/open_webui/routers/first_recharge_bonus.py`)

**æ–°å¢æ¥å£**ï¼š
```
GET /api/v1/first-recharge-bonus/eligibility/tiers
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "enabled": true,
  "tiers": [
    {"tier_amount": 10, "eligible": true},
    {"tier_amount": 50, "eligible": true},
    {"tier_amount": 100, "eligible": false},  // å·²å……å€¼è¿‡
    {"tier_amount": 200, "eligible": true},
    {"tier_amount": 500, "eligible": true},
    {"tier_amount": 1000, "eligible": true}
  ]
}
```

### 3. æ”¯ä»˜å›è°ƒ (`backend/open_webui/routers/billing.py`)

**ä¿®æ”¹é€»è¾‘**ï¼š
```python
# é¢„è®¾æ¡£ä½ï¼ˆæ¯«ï¼‰
PRESET_TIERS = [100000, 500000, 1000000, 2000000, 5000000, 10000000]

# ç²¾ç¡®åŒ¹é…æ¡£ä½
if order.amount in PRESET_TIERS:
    matched_tier = order.amount
    # æ£€æŸ¥è¯¥æ¡£ä½æ˜¯å¦å·²å‚ä¸
    if not FirstRechargeBonusLogs.has_participated_tier(user_id, matched_tier):
        # å‘æ”¾é¦–å……ä¼˜æƒ 
        ...
```

### 4. å‰ç«¯ API (`src/lib/apis/billing/index.ts`)

**æ–°å¢æ¥å£**ï¼š
- `checkTiersEligibility(token)` - æ£€æŸ¥æ‰€æœ‰æ¡£ä½èµ„æ ¼

**æ–°å¢ç±»å‹**ï¼š
```typescript
interface TierEligibility {
  tier_amount: number;
  eligible: boolean;
}

interface TiersEligibilityResponse {
  enabled: boolean;
  tiers: TierEligibility[];
}
```

### 5. å‰ç«¯ UI (`src/lib/components/billing/RechargeCard.svelte`)

**ä¿®æ”¹ç‚¹**ï¼š
- è°ƒç”¨ `checkTiersEligibility` API è·å–æ¡£ä½èµ„æ ¼
- æ ¹æ®æ¯ä¸ªæ¡£ä½çš„èµ„æ ¼æ˜¾ç¤º/éšè— `ğŸ +Â¥X` æ ‡ç­¾
- è‡ªå®šä¹‰é‡‘é¢è¾“å…¥æ¡†æ˜¾ç¤ºæç¤ºï¼šã€Œä»…é¢„è®¾æ¡£ä½äº«å—é¦–å……ä¼˜æƒ ã€
- å®æ—¶è®¡ç®—å¡ç‰‡ä»…åœ¨é€‰ä¸­æœ‰èµ„æ ¼çš„æ¡£ä½æ—¶æ˜¾ç¤º
- è°ƒè¯•é¢æ¿æ˜¾ç¤ºæ‰€æœ‰æ¡£ä½çš„è¯¦ç»†èµ„æ ¼çŠ¶æ€

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1ï¼šè¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd backend

# è¿è¡Œè¿ç§»
alembic upgrade head
```

**è¿ç§»è„šæœ¬**ï¼š`backend/open_webui/migrations/versions/tier_based_first_recharge_bonus.py`

**è¿ç§»å†…å®¹**ï¼š
1. æ·»åŠ  `tier_amount` å­—æ®µ
2. å°†ç°æœ‰è®°å½•çš„ `tier_amount` è®¾ç½®ä¸º `recharge_amount`ï¼ˆå‘åå…¼å®¹ï¼‰
3. åˆ é™¤ `user_id` å”¯ä¸€ç´¢å¼•
4. åˆ›å»º `(user_id, tier_amount)` å¤åˆå”¯ä¸€ç´¢å¼•

### æ­¥éª¤ 2ï¼šé‡å¯åç«¯æœåŠ¡

```bash
# Docker éƒ¨ç½²
docker-compose restart open-webui

# æˆ–æ‰‹åŠ¨é‡å¯
python -m uvicorn open_webui.main:app --reload
```

### æ­¥éª¤ 3ï¼šå‰ç«¯é‡æ–°æ„å»ºï¼ˆå¦‚éœ€è¦ï¼‰

```bash
cd open-webui-next

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœ‰å˜æ›´ï¼‰
npm install

# æ„å»ºå‰ç«¯
npm run build
```

### æ­¥éª¤ 4ï¼šéªŒè¯éƒ¨ç½²

1. æ‰“å¼€å……å€¼é¡µé¢
2. ç‚¹å‡»å³ä¸Šè§’ **ğŸ” è°ƒè¯•** æŒ‰é’®
3. æŸ¥çœ‹æ¡£ä½èµ„æ ¼è¯¦æƒ…

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šæ–°ç”¨æˆ·ï¼ˆä»æœªå……å€¼ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- æ‰€æœ‰æ¡£ä½æ˜¾ç¤º `ğŸ +Â¥X` æ ‡ç­¾
- è°ƒè¯•é¢æ¿æ˜¾ç¤ºæ‰€æœ‰æ¡£ä½ `âœ… å¯äº«é¦–å……`

### åœºæ™¯ 2ï¼šå……å€¼100å…ƒæ¡£ä½

**æ“ä½œ**ï¼šé€‰æ‹©100å…ƒæ¡£ä½ â†’ å……å€¼æˆåŠŸ

**é¢„æœŸç»“æœ**ï¼š
- 100å…ƒæ¡£ä½æ ‡ç­¾æ¶ˆå¤±
- å…¶ä»–æ¡£ä½æ ‡ç­¾ä»å­˜åœ¨
- æ•°æ®åº“è®°å½•ï¼š`tier_amount = 1000000`ï¼ˆ100å…ƒï¼‰

### åœºæ™¯ 3ï¼šå……å€¼è‡ªå®šä¹‰é‡‘é¢

**æ“ä½œ**ï¼šè¾“å…¥99å…ƒ â†’ å……å€¼æˆåŠŸ

**é¢„æœŸç»“æœ**ï¼š
- æ‰€æœ‰æ¡£ä½æ ‡ç­¾ä»å­˜åœ¨ï¼ˆæœªåŒ¹é…ä»»ä½•æ¡£ä½ï¼‰
- æ— é¦–å……å¥–åŠ±å‘æ”¾
- æ•°æ®åº“æ— æ–°è®°å½•

### åœºæ™¯ 4ï¼šå·²å……å€¼ç”¨æˆ·ï¼ˆæ•°æ®è¿ç§»ï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·åœ¨æ—§ç³»ç»Ÿä¸­å……å€¼è¿‡ 100.50å…ƒ

**é¢„æœŸç»“æœ**ï¼š
- è¯¥ç”¨æˆ·çš„ `tier_amount = 1005000`ï¼ˆ100.50å…ƒï¼‰
- ç”±äºä¸åœ¨é¢„è®¾æ¡£ä½ä¸­ï¼Œæ‰€æœ‰é¢„è®¾æ¡£ä½æ ‡ç­¾ä»æ˜¾ç¤º
- ç”¨æˆ·å¯ä»¥å……å€¼æ‰€æœ‰é¢„è®¾æ¡£ä½å¹¶äº«å—é¦–å……

---

## ğŸ“ é…ç½®è¯´æ˜

### é¢„è®¾æ¡£ä½å®šä¹‰

**ä½ç½®**ï¼š
- åç«¯ï¼š`backend/open_webui/routers/billing.py:868`
- åç«¯APIï¼š`backend/open_webui/routers/first_recharge_bonus.py:266`
- å‰ç«¯ï¼š`src/lib/components/billing/RechargeCard.svelte:31`

**å½“å‰å€¼**ï¼š
```python
# åç«¯ï¼ˆæ¯«ï¼‰
PRESET_TIERS = [100000, 500000, 1000000, 2000000, 5000000, 10000000]

# å‰ç«¯ï¼ˆå…ƒï¼‰
amountOptions = [10, 50, 100, 200, 500, 1000]
```

**ä¿®æ”¹æ–¹æ³•**ï¼š
å¦‚éœ€ä¿®æ”¹æ¡£ä½ï¼Œéœ€è¦åŒæ—¶ä¿®æ”¹3ä¸ªä½ç½®ï¼ˆä¿æŒä¸€è‡´ï¼‰

---

## ğŸ” è°ƒè¯•å·¥å…·

### ä½¿ç”¨è°ƒè¯•é¢æ¿

1. æ‰“å¼€å……å€¼é¡µé¢
2. ç‚¹å‡»å³ä¸Šè§’ **ğŸ” è°ƒè¯•** æŒ‰é’®

**æ˜¾ç¤ºä¿¡æ¯**ï¼š
```
ğŸ” é¦–å……ä¼˜æƒ çŠ¶æ€
é…ç½®å·²åŠ è½½:   âœ… æ˜¯ / âŒ å¦
åå°å·²å¯ç”¨:   âœ… æ˜¯ / âŒ å¦
ç”¨æˆ·ç¬¦åˆèµ„æ ¼: âœ… æ˜¯ / âŒ å¦
æ˜¾ç¤ºæ¨ªå¹…:     âœ… æ˜¯ / âšª å¦
è¿”ç°æ¯”ä¾‹:     20%
æœ€é«˜é‡‘é¢:     Â¥100.00

ğŸ“Š æ¡£ä½èµ„æ ¼è¯¦æƒ…
Â¥10:   âœ… å¯äº«é¦–å……
Â¥50:   âœ… å¯äº«é¦–å……
Â¥100:  âšª å·²å……å€¼è¿‡
Â¥200:  âœ… å¯äº«é¦–å……
Â¥500:  âœ… å¯äº«é¦–å……
Â¥1000: âœ… å¯äº«é¦–å……
```

### æ•°æ®åº“æŸ¥è¯¢

```sql
-- æŸ¥è¯¢ç”¨æˆ·å·²å……å€¼çš„æ¡£ä½
SELECT user_id, tier_amount, recharge_amount, bonus_amount, created_at
FROM first_recharge_bonus_log
WHERE user_id = 'user_id_here';

-- æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·çš„æ¡£ä½ç»Ÿè®¡
SELECT tier_amount / 10000 AS tier_yuan, COUNT(*) AS user_count
FROM first_recharge_bonus_log
GROUP BY tier_amount
ORDER BY tier_amount;
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§

- æ•°æ®åº“è¿ç§»ä¼šè‡ªåŠ¨å¤„ç†ç°æœ‰è®°å½•
- è¿ç§»åç°æœ‰ç”¨æˆ·çš„ `tier_amount` ç­‰äºå…¶ `recharge_amount`
- è¿™æ„å‘³ç€ä»–ä»¬çš„å……å€¼é‡‘é¢å¯èƒ½ä¸åœ¨é¢„è®¾æ¡£ä½ä¸­ï¼Œä¸å½±å“å…¶äº«å—æ–°æ¡£ä½çš„é¦–å……

### 2. è‡ªå®šä¹‰é‡‘é¢

- ç”¨æˆ·å¯ä»¥è¾“å…¥è‡ªå®šä¹‰é‡‘é¢å……å€¼
- **è‡ªå®šä¹‰é‡‘é¢ä¸äº«å—é¦–å……ä¼˜æƒ **
- è¾“å…¥æ¡†ä¸‹æ–¹ä¼šæ˜¾ç¤ºæç¤ºï¼šã€Œä»…é¢„è®¾æ¡£ä½äº«å—é¦–å……ä¼˜æƒ ã€

### 3. ç²¾ç¡®åŒ¹é…

- åªæœ‰å……å€¼é‡‘é¢**ç²¾ç¡®ç­‰äº**é¢„è®¾æ¡£ä½æ‰äº«å—é¦–å……
- ä¾‹å¦‚ï¼šå……å€¼99å…ƒä¸ä¼šåŒ¹é…100å…ƒæ¡£ä½

### 4. å‘åå…¼å®¹

- æ—§çš„ `/eligibility` API ä»ç„¶å¯ç”¨
- åˆ¤æ–­é€»è¾‘ï¼šç”¨æˆ·æ˜¯å¦å‚ä¸è¿‡**ä»»ä½•æ¡£ä½**çš„é¦–å……

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### æ•°æ®åº“ç´¢å¼•è®¾è®¡

```sql
-- å¤åˆå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX uq_user_tier
ON first_recharge_bonus_log (user_id, tier_amount);

-- å•åˆ—ç´¢å¼•ï¼ˆç”¨äºæŸ¥è¯¢ï¼‰
CREATE INDEX idx_user_id ON first_recharge_bonus_log (user_id);
CREATE INDEX idx_created_at ON first_recharge_bonus_log (created_at);
```

### API å“åº”ç¼“å­˜

å»ºè®®åœ¨å‰ç«¯ç¼“å­˜ `checkTiersEligibility` çš„ç»“æœï¼š
- ç”¨æˆ·åˆ·æ–°é¡µé¢æ—¶é¿å…é‡å¤è¯·æ±‚
- å……å€¼æˆåŠŸåæ¸…é™¤ç¼“å­˜

### æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ `Promise.all` å¹¶è¡Œè¯·æ±‚é…ç½®å’Œèµ„æ ¼
- æ¡£ä½èµ„æ ¼æ„å»ºä¸º Map ä¾¿äºå¿«é€ŸæŸ¥æ‰¾
- é¿å…åœ¨æ¸²æŸ“å¾ªç¯ä¸­é‡å¤è®¡ç®—

---

## ğŸ“š ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

- `backend/open_webui/models/billing.py` - æ•°æ®æ¨¡å‹ä¿®æ”¹
- `backend/open_webui/routers/billing.py` - æ”¯ä»˜å›è°ƒä¿®æ”¹
- `backend/open_webui/routers/first_recharge_bonus.py` - APIä¿®æ”¹
- `backend/open_webui/migrations/versions/tier_based_first_recharge_bonus.py` - è¿ç§»è„šæœ¬

### å‰ç«¯æ–‡ä»¶

- `src/lib/apis/billing/index.ts` - APIç±»å‹å’Œå‡½æ•°
- `src/lib/components/billing/RechargeCard.svelte` - å……å€¼å¡ç‰‡UI

### æ–‡æ¡£æ–‡ä»¶

- `docs/FIRST_RECHARGE_PROMOTION_GUIDE.md` - é¦–å……ä¼˜æƒ æ•´ä½“æŒ‡å—ï¼ˆéœ€æ›´æ–°ï¼‰
- `docs/TIER_BASED_FIRST_RECHARGE_IMPLEMENTATION.md` - æœ¬æ–‡æ¡£

---

## ğŸ‰ å®ŒæˆçŠ¶æ€

- [x] æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡
- [x] æ•°æ®åº“è¿ç§»è„šæœ¬
- [x] åç«¯æ•°æ®è®¿é—®å±‚ä¿®æ”¹
- [x] åç«¯APIä¿®æ”¹
- [x] æ”¯ä»˜å›è°ƒé€»è¾‘ä¿®æ”¹
- [x] å‰ç«¯APIç±»å‹å®šä¹‰
- [x] å‰ç«¯UIä¿®æ”¹
- [x] è°ƒè¯•å·¥å…·
- [x] å®æ–½æ–‡æ¡£

---

**å®æ–½å®Œæˆæ—¶é—´**: 2026-01-18
**ç‰ˆæœ¬**: v2.0 (æ¡£ä½ç‹¬ç«‹é¦–å……)
