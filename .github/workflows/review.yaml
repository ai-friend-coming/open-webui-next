# AI PR Reviewer å¯é…ç½®ç‰ˆæœ¬
# æ–‡ä»¶ä½ç½®: .github/workflows/ai-pr-reviewer.yml
#
# ===== é…ç½®è¯´æ˜ =====
# åœ¨ä»“åº“ Settings â†’ Secrets and variables â†’ Actions ä¸­é…ç½®ï¼š
#
# ã€Secretsï¼ˆå¿…é¡»ï¼‰ã€‘
# - OPENAI_API_KEY: API å¯†é’¥
#
# ã€Variablesï¼ˆå¯é€‰ï¼‰ã€‘
# - OPENAI_BASE_URL: API åœ°å€ï¼ˆé»˜è®¤: https://api.openai.com/v1ï¼‰
# - OPENAI_LIGHT_MODEL: è½»é‡æ¨¡å‹ï¼ˆé»˜è®¤: gpt-3.5-turboï¼‰
# - OPENAI_HEAVY_MODEL: é‡é‡æ¨¡å‹ï¼ˆé»˜è®¤: gpt-4ï¼‰
# - AI_REVIEW_LANGUAGE: å®¡æŸ¥è¯­è¨€ï¼ˆé»˜è®¤: zh-CNï¼‰

name: AI Code Review

permissions:
  contents: read
  pull-requests: write

on:
  # åªåœ¨ PR äº‹ä»¶è§¦å‘å®¡æŸ¥
  pull_request_target:
    types: [opened, synchronize, reopened]
  # æ”¯æŒè¯„è®ºäº¤äº’
  pull_request_review_comment:
    types: [created]

concurrency:
  group: ${{ github.repository }}-${{ github.event.number || github.head_ref || github.sha }}-${{ github.workflow }}-${{ github.event_name == 'pull_request_review_comment' && 'pr_comment' || 'pr' }}
  cancel-in-progress: ${{ github.event_name != 'pull_request_review_comment' }}

jobs:
  review:
    runs-on: ubuntu-latest
    # è·³è¿‡ draft PR
    if: github.event.pull_request.draft == false
    steps:
      - uses: coderabbitai/ai-pr-reviewer@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          # API é…ç½®ï¼ˆé€šè¿‡ Variables è‡ªå®šä¹‰ï¼‰
          openai_base_url: ${{ vars.OPENAI_BASE_URL || 'https://yunwu.ai/v1' }}
          openai_light_model: ${{ vars.OPENAI_LIGHT_MODEL || 'gpt-5.2-codex' }}
          openai_heavy_model: ${{ vars.OPENAI_HEAVY_MODEL || 'gpt-5.2-codex' }}

          # å®¡æŸ¥é…ç½®
          language: ${{ vars.AI_REVIEW_LANGUAGE || 'zh-CN' }}
          debug: false
          review_simple_changes: false
          review_comment_lgtm: false
          max_files: '100'
          openai_timeout_ms: '360000'
          openai_retries: '5'

          # æ–‡ä»¶è¿‡æ»¤ï¼ˆåŸºäº open-webui é¡¹ç›®ç»“æ„ï¼‰
          path_filters: |
            # ===== åŒ…å«ï¼šåç«¯ Python =====
            backend/**/*.py

            # ===== åŒ…å«ï¼šå‰ç«¯ Svelte/TypeScript/JavaScript =====
            src/**/*.svelte
            src/**/*.ts
            src/**/*.js
            src/**/*.mjs
            src/**/*.cjs

            # ===== æ’é™¤ï¼šæµ‹è¯•æ–‡ä»¶ =====
            !**/*.test.*
            !**/*.spec.*
            !**/__tests__/**
            !**/test_*.py
            !**/*_test.py
            !**/tests/**

            # ===== æ’é™¤ï¼šä¾èµ–å’Œæ„å»ºäº§ç‰© =====
            !**/node_modules/**
            !**/dist/**
            !**/build/**
            !**/__pycache__/**
            !**/.venv/**
            !**/venv/**

            # ===== æ’é™¤ï¼šé”æ–‡ä»¶å’Œé…ç½® =====
            !**/*.lock
            !**/package-lock.json
            !**/uv.lock
            !**/poetry.lock
            !**/*.json
            !**/*.yaml
            !**/*.yml
            !**/*.toml

            # ===== æ’é™¤ï¼šæ–‡æ¡£å’Œé™æ€èµ„æº =====
            !**/*.md
            !**/*.txt
            !**/*.rst
            !**/static/**
            !**/*.svg
            !**/*.png
            !**/*.jpg
            !**/*.jpeg
            !**/*.gif
            !**/*.ico
            !**/*.woff
            !**/*.woff2
            !**/*.ttf
            !**/*.eot

            # ===== æ’é™¤ï¼ši18n ç¿»è¯‘æ–‡ä»¶ =====
            !**/i18n/**
            !**/locales/**

            # ===== æ’é™¤ï¼šè¿ç§»æ–‡ä»¶ =====
            !**/migrations/**
            !**/alembic/**

          # ç³»ç»Ÿæç¤ºè¯
          system_message: |
            ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å…¨æ ˆå·¥ç¨‹å¸ˆï¼Œç†Ÿæ‚‰ open-webui é¡¹ç›®ï¼ˆPython FastAPI åç«¯ + Svelte å‰ç«¯ï¼‰ã€‚è¯·ä½¿ç”¨ä¸­æ–‡å›å¤ã€‚

            ## æŠ€æœ¯æ ˆ
            - åç«¯ï¼šPython 3.11+, FastAPI, SQLAlchemy, Pydantic
            - å‰ç«¯ï¼šSvelteKit, TypeScript, TailwindCSS
            - æ•°æ®åº“ï¼šSQLite/PostgreSQL, ChromaDB (å‘é‡æ•°æ®åº“)

            ## å®¡æŸ¥é‡ç‚¹
            - ğŸ”´ ä¸¥é‡ï¼šå®‰å…¨æ¼æ´ï¼ˆSQLæ³¨å…¥ã€XSSã€è®¤è¯ç»•è¿‡ï¼‰ã€æ•°æ®æ³„éœ²ã€é€»è¾‘é”™è¯¯
            - ğŸŸ¡ ä¸€èˆ¬ï¼šæ€§èƒ½é—®é¢˜ã€é”™è¯¯å¤„ç†ä¸å½“ã€ç±»å‹å®‰å…¨
            - ğŸ’¡ å»ºè®®ï¼šä»£ç ä¼˜åŒ–ã€æœ€ä½³å®è·µ

            ## è§„åˆ™
            - å¿½ç•¥ä»£ç æ ¼å¼é—®é¢˜ï¼ˆç”± linter å¤„ç†ï¼‰
            - ä¿æŒç®€æ´ï¼Œç›´æ¥æŒ‡å‡ºé—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
            - ä¸¥é‡é—®é¢˜å¿…é¡»æ ‡æ³¨ ğŸ”´
